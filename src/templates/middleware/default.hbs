/**
 * {{name}}Middleware
 * 
 * A pure TypeScript middleware class implementing IStruktosMiddleware.
 * Generated by @struktos/cli on {{timestamp}}
 * 
 * Usage:
 *   app.use(new {{name}}Middleware());
 */

import { 
  IStruktosMiddleware, 
  MiddlewareContext, 
  NextFunction,
  StruktosContextData 
} from '@struktos/core';

/**
 * {{name}} Middleware
 * 
 * Intercepts requests and responses in the middleware pipeline.
 * No decorators - pure TypeScript class.
 */
export class {{name}}Middleware<T extends StruktosContextData = StruktosContextData> 
  implements IStruktosMiddleware<T> {
  
  private readonly name = '{{name}}Middleware';

  /**
   * Constructor for dependency injection
   */
  constructor(
    // Inject dependencies here, e.g.:
    // private readonly logger: ILogger,
  ) {}

  /**
   * Middleware invocation method
   * 
   * @param ctx - The middleware context with request, response, and context data
   * @param next - Function to call the next middleware in the chain
   */
  async invoke(ctx: MiddlewareContext<T>, next: NextFunction): Promise<void> {
    const start = Date.now();
    const traceId = ctx.context.get('traceId' as keyof T) as string || 'unknown';
    const methodName = ctx.request.method || 'unknown';
    const path = ctx.request.path || 'unknown';

    // Pre-processing
    console.log(`[${this.name}] [START] ${methodName} ${path} (Trace: ${traceId})`);

    try {
      // Call next middleware in the pipeline
      await next();

      // Post-processing on success
      const duration = Date.now() - start;
      console.log(`[${this.name}] [END] ${methodName} ${path} completed in ${duration}ms`);
      
    } catch (error) {
      // Error handling
      const duration = Date.now() - start;
      const errorMessage = error instanceof Error ? error.message : 'Unknown error';
      console.error(`[${this.name}] [ERROR] ${methodName} ${path} failed after ${duration}ms:`, errorMessage);
      
      // Re-throw the error to propagate it up the middleware chain
      throw error;
    }
  }
}

/**
 * Factory function for creating the middleware
 */
export function create{{name}}Middleware<T extends StruktosContextData = StruktosContextData>(): {{name}}Middleware<T> {
  return new {{name}}Middleware<T>();
}